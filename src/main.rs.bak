use rand::Rng;
use std::collections::HashSet;
use std::env;

const UPPERCASE: &str = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const LOWERCASE: &str = "abcdefghijklmnopqrstuvwxyz";
const NUMBERS: &str = "0123456789";
const SPECIAL: &str = "~!@#$%^&*()-_=+[];:,.<>/?\\|";

fn generate_password(length: usize) -> String {
    let mut rng = rand::thread_rng();
    let mut password = String::new();
    let mut used_chars = HashSet::new();

    let mut add_char = |set: &str| {
        let mut ch;
        loop {
            ch = set.chars().nth(rng.gen_range(0..set.len())).unwrap();
            if !used_chars.contains(&ch.to_ascii_lowercase()) {
                used_chars.insert(ch.to_ascii_lowercase());
                break;
            }
        }
        password.push(ch);
    };

    add_char(UPPERCASE);
    add_char(LOWERCASE);
    add_char(NUMBERS);
    add_char(SPECIAL);

    while password.len() < length {
        let sets = [UPPERCASE, LOWERCASE, NUMBERS, SPECIAL];
        let set = sets[rng.gen_range(0..sets.len())];
        add_char(set);
    }

    password
}

fn is_valid(password: &str) -> bool {
    let mut has_upper = false;
    let mut has_lower = false;
    let mut has_number = false;
    let mut has_special = false;
    let mut last_char = '\0';

    for ch in password.chars() {
        if ch.is_uppercase() {
            if has_upper && last_char.is_uppercase() {
                return false;
            }
            has_upper = true;
        } else if ch.is_lowercase() {
            if has_lower && last_char.is_lowercase() {
                return false;
            }
            has_lower = true;
        } else if ch.is_digit(10) {
            if has_number && last_char.is_digit(10) {
                return false;
            }
            has_number = true;
        } else {
            if has_special && !last_char.is_alphanumeric() {
                return false;
            }
            has_special = true;
        }
        last_char = ch;
    }

    has_upper && has_lower && has_number && has_special
}

fn main() {
    let args: Vec<String> = env::args().collect();
    if args.len() != 3 {
        eprintln!("Usage: {} <length> <count>", args[0]);
        std::process::exit(1);
    }

    let length: usize = args[1].parse().expect("Invalid length");
    let count: usize = args[2].parse().expect("Invalid count");

    if length < 16 {
        eprintln!("Password length must be at least 16 characters.");
        std::process::exit(1);
    }

    for _ in range(0..count) {
        let mut password;
        loop {
            password = generate_password(length);
            if is_valid(&password) {
                break;
            }
        }
        println!("{}", password);
    }
}

// end of source
